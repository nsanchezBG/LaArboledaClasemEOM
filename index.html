<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Arboleda - Juego de Premios</title>
    
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (v11) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase to the global scope for React to use
        window.FirebaseAPI = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, serverTimestamp };
    </script>

    <style>
        /* Custom Animations & Styles */
        body { margin: 0; overflow: hidden; background-color: #ffffff; font-family: 'Montserrat', sans-serif; touch-action: none; }
        .app-container { max-width: 480px; margin: 0 auto; height: 100vh; height: 100dvh; position: relative; overflow: hidden; background-color: #ffffff; box-shadow: 0 0 40px rgba(0,0,0,0.1); }
        
        .fade-enter { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .bounce-in { animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
        
        /* Nuevas Animaciones para Splashscreen y Transiciones */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        .pop-in { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; }
        
        @keyframes spinSlow { 100% { transform: rotate(360deg); } }
        .spin-slow { animation: spinSlow 20s linear infinite; }

        @keyframes bounceDown { 
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(8px); }
        }
        .animate-bounce-down { animation: bounceDown 1.5s ease-in-out infinite; }

        @keyframes bounceRight {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(8px); }
        }
        .animate-bounce-right { animation: bounceRight 1.5s ease-in-out infinite; }

        @keyframes bounceLeft {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-8px); }
        }
        .animate-bounce-left { animation: bounceLeft 1.5s ease-in-out infinite; }

        /* Nueva Animaci贸n de Error/Sacudida */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        /* Animaciones del Juego */
        @keyframes scorePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.6); }
            100% { transform: scale(1); }
        }
        .score-pop { animation: scorePop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-block; }

        @keyframes warningPulse {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.35; }
        }
        .animate-warning-pulse { animation: warningPulse 1s ease-in-out infinite; }

        /* Ocultar scrollbars */
        ::-webkit-scrollbar { display: none; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .text-brand { color: #0878A4; } /* Azul Inmobiliaria */
        .text-accent { color: #F9137C; } /* Rosa Resaltado */
        .bg-brand { background-color: #F9137C; color: #ffffff; } /* Rosa para botones */
        .bg-brand:hover { background-color: #d80b68; }
        .bg-primary { background-color: #0878A4; } /* Azul para fondos */
        
        canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIGURACIN Y ASSETS ---
        const ASSETS = {
            logoClasem: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/logoclasem.png?raw=true',
            logoArboleda: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/logoarboleda.png?raw=true',
            rueda: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/rueda.png?raw=true',
            bodegon: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/bodegon.png?raw=true',
            dedoarriba: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/dedoarriba.webp?raw=true',
            caja: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/caja.webp?raw=true',
            foco: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/foco.webp?raw=true',
            fondo: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/fondo.png?raw=true',
            timer: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/timer.png?raw=true',
            beep: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/beep.mp3?raw=true',
            prizes: [
                { id: 'tier1', name: 'Microondas', minBoxes: 15, image: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/microondas.png?raw=true' },
                { id: 'tier2', name: 'Lavadora', minBoxes: 25, image: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/lavadora.png?raw=true' },
                { id: 'tier3', name: 'Refrigeradora', minBoxes: 35, image: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/refri.webp?raw=true' }
            ]
        };

        const MAX_ATTEMPTS = 5;
        const GAME_DURATION = 30; // Segundos

        // --- SISTEMA DE BASE DE DATOS (MOCK / FIREBASE) ---
        // Preparado para Looker Studio con estructura plana
        const DBService = {
            db: null,
            user: null,
            isMock: true,
            
            async init() {
                try {
                    // Intenta inicializar Firebase si existe la configuraci贸n (en producci贸n)
                    if (typeof window.FirebaseAPI !== 'undefined' && typeof __firebase_config !== 'undefined' && __firebase_config) {
                        const config = JSON.parse(__firebase_config);
                        const app = window.FirebaseAPI.initializeApp(config);
                        const auth = window.FirebaseAPI.getAuth(app);
                        this.db = window.FirebaseAPI.getFirestore(app);
                        
                        // Autenticaci贸n asegurada con Custom Token
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await window.FirebaseAPI.signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await window.FirebaseAPI.signInAnonymously(auth);
                        }
                        
                        // Escuchar estado de auth
                        window.FirebaseAPI.onAuthStateChanged(auth, (user) => {
                            if (user) this.user = user;
                        });

                        this.user = auth.currentUser;
                        this.isMock = false;
                        console.log("Firebase conectado correctamente.");
                    } else {
                        console.log("Modo Demo: Base de datos desconectada (Mock).");
                    }
                } catch (error) {
                    console.log("Modo Demo: Usando base de datos local (Mock). Error:", error);
                }
            },

            async savePlayerResult(data) {
                if (!this.isMock && !this.user) {
                    console.error("Error guardando: Usuario no autenticado.");
                    return false;
                }

                const payload = {
                    ...data,
                    userId: this.user ? this.user.uid : 'mock-user-id',
                    attemptsDetails: JSON.stringify(data.attempts), // Array stringified for Looker Studio flat schema
                    timestamp: this.isMock ? new Date().toISOString() : window.FirebaseAPI.serverTimestamp(),
                };

                if (this.isMock) {
                    console.log(" [Mock DB] Datos guardados:", payload);
                    return true;
                } else {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        // Guardamos en un path p煤blico para f谩cil recolecci贸n desde Looker Studio
                        const colRef = window.FirebaseAPI.collection(this.db, 'artifacts', appId, 'public', 'data', 'arboleda_winners');
                        await window.FirebaseAPI.addDoc(colRef, payload);
                        return true;
                    } catch (e) {
                        console.error("Error guardando en Firestore:", e);
                        return false;
                    }
                }
            }
        };

        // --- COMPONENTES UI REUTILIZABLES ---
        const TopBrandBar = () => (
            <div className="w-full flex justify-between items-center mb-6 shrink-0 pt-4 px-2">
                <img src={ASSETS.logoClasem} alt="Clasem" className="h-6 object-contain drop-shadow-sm" />
                <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-6 object-contain drop-shadow-sm" style={{ filter: 'brightness(0) saturate(100%) invert(32%) sepia(85%) saturate(3015%) hue-rotate(318deg) brightness(101%) contrast(97%)' }} />
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = '' }) => {
            const baseClass = "w-full py-4 rounded-xl font-bold text-lg transition-transform transform active:scale-95 shadow-lg flex justify-center items-center gap-2";
            const variants = {
                primary: "bg-brand text-white hover:bg-pink-700",
                secondary: "bg-white text-accent border-2 border-[#F9137C] hover:bg-pink-50",
                disabled: "bg-[#F9137C] opacity-50 text-white cursor-not-allowed shadow-none"
            };
            return (
                <button onClick={onClick} className={`${baseClass} ${variants[variant]} ${className}`} disabled={variant === 'disabled'}>
                    {children}
                </button>
            );
        };

        // --- FUNCIONES DE DIBUJO COMPARTIDAS ---
        const drawTruckShape = (ctx, x, y, w, h, logoImg) => {
            ctx.fillStyle = '#0878A4'; // Cabina Azul
            ctx.beginPath();
            ctx.roundRect(x + w*0.7, y + h*0.2, w*0.3, h*0.8, 5);
            ctx.fill();
            
            ctx.fillStyle = '#e2e8f0'; // Ventana
            ctx.fillRect(x + w*0.75, y + h*0.3, w*0.2, h*0.3);

            ctx.fillStyle = '#f8fafc'; // Caja trasera (blanca)
            ctx.beginPath();
            ctx.roundRect(x, y, w*0.75, h, 8);
            ctx.fill();
            
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Llantas
            ctx.fillStyle = '#1e293b';
            ctx.beginPath();
            ctx.arc(x + w*0.2, y + h, 12, 0, Math.PI * 2);
            ctx.arc(x + w*0.8, y + h, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#cbd5e1'; // rines
            ctx.beginPath();
            ctx.arc(x + w*0.2, y + h, 5, 0, Math.PI * 2);
            ctx.arc(x + w*0.8, y + h, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // Logo pintado en el cami贸n (Livery)
            if (logoImg && logoImg.complete && logoImg.naturalWidth !== 0) {
                const logoW = w * 0.55;
                const aspect = logoImg.naturalHeight / logoImg.naturalWidth;
                const logoH = logoW * aspect;
                ctx.drawImage(logoImg, x + (w*0.75)/2 - logoW/2, y + h/2 - logoH/2, logoW, logoH);
            } else {
                ctx.fillStyle = '#0878A4';
                ctx.font = 'bold 10px sans-serif';
                ctx.fillText('CLASEM', x + 5, y + h/2 + 5);
            }
        };

        const drawBoxShape = (ctx, x, y, size, boxImg) => {
            if (boxImg && boxImg.complete && boxImg.naturalWidth !== 0) {
                ctx.drawImage(boxImg, x, y, size, size);
            } else {
                ctx.fillStyle = '#d97706'; // Color cart贸n
                ctx.fillRect(x, y, size, size);
                ctx.fillStyle = '#b45309'; // Cinta adhesiva
                ctx.fillRect(x + size/2 - 2, y, 4, size);
                ctx.fillRect(x, y + size/2 - 2, size, 4);
                // S铆mbolo
                ctx.fillStyle = '#fef3c7';
                ctx.font = `${Math.floor(size*0.45)}px sans-serif`;
                ctx.fillText('', x + size*0.1, y + size - size*0.15);
            }
        };

        // --- COMPONENTE CAMIN DE CARGA (TRANSICIN) ---
        const TruckPreview = () => {
            const canvasRef = useRef(null);
            const logoImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.logoClasem;
                return img;
            }, []);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;
                let lastTime = Date.now();

                const resize = () => {
                    const size = canvas.parentElement.clientWidth;
                    canvas.width = size;
                    canvas.height = size * 0.6;
                };
                resize();
                window.addEventListener('resize', resize);

                const truck = { width: 150, height: 90, x: canvas.width/2 - 75, y: canvas.height/2 - 45 };

                const loop = () => {
                    const now = Date.now();
                    lastTime = now;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Animaci贸n de flotaci贸n suave simulando marcha
                    const floatY = Math.sin(now / 200) * 8;

                    ctx.save();
                    ctx.translate(0, floatY);
                    drawTruckShape(ctx, truck.x, truck.y, truck.width, truck.height, logoImg);
                    ctx.restore();

                    animationId = requestAnimationFrame(loop);
                };
                animationId = requestAnimationFrame(loop);

                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', resize);
                };
            }, [logoImg]);

            return <canvas ref={canvasRef} className="w-full h-full drop-shadow-2xl"></canvas>;
        };

        // --- COMPONENTE MINI-TUTORIAL (SIMULACIN DE MOTOR) ---
        const MiniGamePreview = () => {
            const canvasRef = useRef(null);
            const logoImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.logoClasem;
                return img;
            }, []);
            const boxImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.caja;
                return img;
            }, []);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;
                let lastTime = Date.now();

                const resize = () => {
                    // Obligamos a que la resoluci贸n interna sea 1:1 (cuadrada)
                    // bas谩ndonos en el ancho real para evitar elementos estirados
                    const size = canvas.parentElement.clientWidth || 280;
                    canvas.width = size;
                    canvas.height = size;
                };
                resize();
                window.addEventListener('resize', resize);

                const truck = { width: 70, height: 42, x: canvas.width/2 - 35, y: canvas.height - 50 };
                const boxes = [];
                let boxSpawnTimer = 0;
                let truckInflate = 0;

                const loop = () => {
                    const now = Date.now();
                    const dt = (now - lastTime) / 1000;
                    lastTime = now;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#0878A410'; 
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#cbd5e1';
                    ctx.fillRect(0, canvas.height - 15, canvas.width, 15);

                    // Auto move truck smoothly with sine wave
                    truck.x = (canvas.width / 2 - truck.width/2) + Math.sin(now / 500) * (canvas.width/2 - truck.width);
                    truck.y = canvas.height - truck.height - 10;

                    truckInflate = Math.max(0, truckInflate - dt * 6);

                    boxSpawnTimer -= dt;
                    if (boxSpawnTimer <= 0) {
                        boxes.push({ x: Math.random() * (canvas.width - 25), y: -30, size: 25, speed: 120 });
                        boxSpawnTimer = 0.8;
                    }

                    for (let i = boxes.length - 1; i >= 0; i--) {
                        let b = boxes[i];
                        b.y += b.speed * dt;

                        if (b.y + b.size > truck.y && b.y < truck.y + truck.height && b.x + b.size > truck.x && b.x < truck.x + truck.width) {
                            truckInflate = 1;
                            boxes.splice(i, 1);
                            continue;
                        }
                        if (b.y > canvas.height) {
                            boxes.splice(i, 1);
                            continue;
                        }
                        drawBoxShape(ctx, b.x, b.y, b.size, boxImg);
                    }

                    const scale = 1 + truckInflate * 0.15;
                    ctx.save();
                    ctx.translate(truck.x + truck.width/2, truck.y + truck.height/2);
                    ctx.scale(scale, scale);
                    drawTruckShape(ctx, -truck.width/2, -truck.height/2, truck.width, truck.height, logoImg);
                    ctx.restore();

                    animationId = requestAnimationFrame(loop);
                };
                animationId = requestAnimationFrame(loop);

                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', resize);
                };
            }, [logoImg]);

            return <canvas ref={canvasRef} className="w-full h-full rounded-3xl"></canvas>;
        };

        // --- MOTOR DEL JUEGO (CANVAS) ---
        const GameEngine = ({ onGameOver }) => {
            const canvasRef = useRef(null);
            const scoreSpanRef = useRef(null);
            const [timeLeft, setTimeLeft] = useState(GAME_DURATION);
            const [score, setScore] = useState(0);
            const [showTimeUp, setShowTimeUp] = useState(false);
            
            // Precargas
            const logoImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.logoClasem;
                return img;
            }, []);
            
            const boxImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.caja;
                return img;
            }, []);

            const beepAudio = useMemo(() => new Audio(ASSETS.beep), []);

            useEffect(() => {
                // Forzamos la carga del audio
                beepAudio.load();
            }, [beepAudio]);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;
                let lastTime = Date.now();
                
                // Ajustar tama帽o
                const resize = () => {
                    canvas.width = canvas.parentElement.clientWidth;
                    canvas.height = canvas.parentElement.clientHeight;
                };
                resize();
                window.addEventListener('resize', resize);

                // Estado del juego
                let gameTime = GAME_DURATION;
                let boxesCaught = 0;
                let isFinished = false;
                
                // Cami贸n m谩s grande (130x78 en lugar de 100x60)
                const truck = {
                    width: 130,
                    height: 78,
                    x: canvas.width / 2 - 65,
                    y: canvas.height - 100,
                    color: '#0878A4'
                };

                const boxes = [];
                let boxSpawnTimer = 0;
                let truckInflate = 0;
                let particles = [];

                // Controles (Touch y Mouse)
                const handleMove = (e) => {
                    let clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const rect = canvas.getBoundingClientRect();
                    let targetX = clientX - rect.left - truck.width / 2;
                    // Limites
                    if (targetX < 0) targetX = 0;
                    if (targetX > canvas.width - truck.width) targetX = canvas.width - truck.width;
                    truck.x = targetX;
                };

                canvas.addEventListener('touchmove', handleMove, { passive: true });
                canvas.addEventListener('mousemove', handleMove);

                // Bucle principal
                const gameLoop = () => {
                    if (isFinished) return;

                    const now = Date.now();
                    const dt = (now - lastTime) / 1000;
                    lastTime = now;

                    // Actualizar tiempo
                    gameTime -= dt;
                    if (gameTime <= 0) {
                        isFinished = true;
                        setTimeLeft(0);
                        setShowTimeUp(true);
                        setTimeout(() => {
                            onGameOver(boxesCaught);
                        }, 2000);
                        return; // Fin del juego pausado
                    }
                    setTimeLeft(Math.ceil(gameTime));

                    // Limpiar canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Spawn Cajas
                    boxSpawnTimer -= dt;
                    if (boxSpawnTimer <= 0) {
                        boxes.push({
                            x: Math.random() * (canvas.width - 50),
                            y: -50,
                            size: 45,
                            speed: 150 + Math.random() * 100 // velocidad variable
                        });
                        boxSpawnTimer = 0.7;
                    }

                    // Actualizar estado de inflado del cami贸n
                    truckInflate = Math.max(0, truckInflate - dt * 6);

                    // Actualizar y dibujar cajas
                    for (let i = boxes.length - 1; i >= 0; i--) {
                        let b = boxes[i];
                        b.y += b.speed * dt;
                        
                        // Colisi贸n (AABB simple)
                        if (
                            b.y + b.size > truck.y &&
                            b.y < truck.y + truck.height &&
                            b.x + b.size > truck.x &&
                            b.x < truck.x + truck.width
                        ) {
                            // Atrapada!
                            boxesCaught++;
                            setScore(boxesCaught);
                            boxes.splice(i, 1);

                            // Efectos visuales: Inflar cami贸n y emitir part铆culas
                            truckInflate = 1;
                            for(let p = 0; p < 8; p++) {
                                particles.push({
                                    x: truck.x + truck.width / 2,
                                    y: truck.y,
                                    vx: (Math.random() - 0.5) * 300,
                                    vy: (Math.random() - 1) * 300,
                                    life: 1
                                });
                            }

                            // Disparar audio (reproducci贸n superpuesta)
                            beepAudio.currentTime = 0;
                            beepAudio.play().catch(e => console.log('Audio autoplay prevented'));

                            // Animar el n煤mero del score
                            if (scoreSpanRef.current) {
                                scoreSpanRef.current.classList.remove('score-pop');
                                void scoreSpanRef.current.offsetWidth; // Forzar reflow para reiniciar la animaci贸n CSS
                                scoreSpanRef.current.classList.add('score-pop');
                            }
                            
                            continue;
                        }

                        // Fuera de pantalla
                        if (b.y > canvas.height) {
                            boxes.splice(i, 1);
                            continue;
                        }

                        drawBoxShape(ctx, b.x, b.y, b.size, boxImg);
                    }

                    // Actualizar y dibujar part铆culas
                    for (let i = particles.length - 1; i >= 0; i--) {
                        let p = particles[i];
                        p.x += p.vx * dt;
                        p.y += p.vy * dt;
                        p.vy += 800 * dt; // gravedad
                        p.life -= dt * 1.5;
                        
                        if (p.life <= 0) {
                            particles.splice(i, 1);
                        } else {
                            ctx.fillStyle = `rgba(249, 19, 124, ${p.life})`;
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }

                    // Dibujar cami贸n
                    // Actualizar Y por si cambi贸 el resize
                    truck.y = canvas.height - truck.height - 20;
                    
                    const scale = 1 + truckInflate * 0.15;
                    ctx.save();
                    ctx.translate(truck.x + truck.width/2, truck.y + truck.height/2);
                    ctx.scale(scale, scale);
                    drawTruckShape(ctx, -truck.width/2, -truck.height/2, truck.width, truck.height, logoImg);
                    ctx.restore();

                    animationId = requestAnimationFrame(gameLoop);
                };

                animationId = requestAnimationFrame(gameLoop);

                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', resize);
                    canvas.removeEventListener('touchmove', handleMove);
                    canvas.removeEventListener('mousemove', handleMove);
                };
            }, [onGameOver, beepAudio]);

            return (
                <div className="relative w-full h-full bg-cover bg-center overflow-hidden" style={{backgroundImage: `url(${ASSETS.fondo})`}}>
                    
                    {/* Alerta Radial de 5 segundos */}
                    {timeLeft <= 5 && !showTimeUp && (
                        <div className="absolute inset-0 bg-[#F9137C] z-20 pointer-events-none animate-warning-pulse"></div>
                    )}

                    {/* HUD (Encabezado) */}
                    <div className="absolute top-8 left-0 right-0 px-6 flex justify-between items-center z-30 pointer-events-none">
                        
                        {/* Izquierda: Timer */}
                        <div className="flex items-center gap-2">
                            <img src={ASSETS.timer} className="h-10 object-contain drop-shadow-md" alt="Timer" />
                            <span className="font-black text-[2.5rem] text-[#0878A4] drop-shadow-sm leading-none mt-1.5">{timeLeft < 10 ? `0${timeLeft}` : timeLeft}</span>
                        </div>

                        {/* Centro: Logo (Filtro Magenta) */}
                        <img src={ASSETS.logoArboleda} className="h-12 object-contain drop-shadow-md" style={{ filter: 'brightness(0) saturate(100%) invert(32%) sepia(85%) saturate(3015%) hue-rotate(318deg) brightness(101%) contrast(97%)' }} alt="Logo" />
                        
                        {/* Derecha: Score */}
                        <div className="flex items-center gap-2">
                            <img src={ASSETS.caja} className="h-9 object-contain drop-shadow-md" alt="Caja" />
                            <span ref={scoreSpanRef} className="font-black text-[2.5rem] text-[#F9137C] drop-shadow-sm leading-none mt-1.5">{score < 10 ? `0${score}` : score}</span>
                        </div>
                    </div>
                    
                    {/* Game Canvas */}
                    <canvas ref={canvasRef} className="absolute inset-0 w-full h-full cursor-none z-10"></canvas>
                    
                    {/* Overlay: Tiempo Terminado */}
                    {showTimeUp && (
                        <div className="absolute inset-0 bg-[#F9137C] z-50 flex items-center justify-center fade-enter">
                            <h2 className="text-[4.5rem] font-black text-white uppercase tracking-wider bounce-in drop-shadow-xl">
                                隆TIEMPO!
                            </h2>
                        </div>
                    )}
                </div>
            );
        };

        // --- PANTALLAS (VIEWS) ---

        const SplashView = ({ onNext }) => (
            <div className="flex flex-col items-center justify-between h-full p-6 fade-enter text-center bg-white relative">
                
                {/* Logo Arboleda Top */}
                <div className="w-full flex justify-center pt-8 pop-in" style={{animationDelay: '0.1s'}}>
                    <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-20 object-contain drop-shadow-sm" />
                </div>
                
                {/* Titles */}
                <div className="mt-2 pop-in" style={{animationDelay: '0.2s'}}>
                    <h1 className="text-3xl sm:text-4xl font-black text-[#0878A4] leading-[0.75] uppercase tracking-tight">
                        隆AMUEBLA TU<br/>NUEVO HOGAR!
                    </h1>
                </div>

                {/* Bodeg贸n Unificado con Rueda */}
                <div className="relative w-full flex-1 flex justify-center items-center my-4 min-h-[260px] max-h-[350px]">
                    {/* Rueda giratoria */}
                    <img src={ASSETS.rueda} className="absolute w-[100%] max-w-[380px] spin-slow z-0 pop-in opacity-80" style={{animationDelay: '0.3s'}} alt="Fondo Animado" />
                    
                    {/* Bodeg贸n */}
                    <img src={ASSETS.bodegon} className="relative w-[95%] max-w-[360px] object-contain drop-shadow-2xl pop-in z-10" style={{animationDelay: '0.4s'}} alt="Premios" />
                </div>

                {/* Text & CTA */}
                <div className="w-full flex flex-col items-center pop-in z-20 -mt-2" style={{animationDelay: '0.5s'}}>
                    <h2 className="text-[#F9137C] font-bold text-lg sm:text-xl leading-[0.75] mb-1">
                        Juega y ll茅vate un<br/>electrodom茅stico
                    </h2>
                    <h1 className="text-[#F9137C] font-black text-[3.2rem] uppercase mt-0 mb-1 tracking-wide leading-[0.75]">
                        GRATIS
                    </h1>
                    
                    {/* Bouncing Arrow */}
                    <div className="animate-bounce-down mb-4 mt-2 text-[#F9137C]">
                        <svg width="40" height="24" viewBox="0 0 40 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 24L0 0H40L20 24Z" />
                        </svg>
                    </div>

                    <Button onClick={onNext} className="uppercase text-[300%] leading-none tracking-wider py-4 rounded-3xl w-[90%] max-w-sm mb-4 font-black">
                        PARTICIPAR
                    </Button>
                </div>

                {/* Logo Clasem Bottom */}
                <div className="w-full flex justify-center pb-6 pop-in shrink-0" style={{animationDelay: '0.6s'}}>
                    <img src={ASSETS.logoClasem} alt="Clasem EOM" className="h-8 object-contain" />
                </div>
            </div>
        );

        const RegisterView = ({ onNext }) => {
            const [name, setName] = useState('');
            const [dni, setDni] = useState('');
            const [terms, setTerms] = useState(false);
            const [showTermsModal, setShowTermsModal] = useState(false);
            const [highlightTerms, setHighlightTerms] = useState(false);
            const [highlightName, setHighlightName] = useState(false);
            const [highlightDni, setHighlightDni] = useState(false);

            // Validaci贸n: Nombre > 3 caracteres, DNI > 0, T茅rminos aceptados
            const isNameValid = name.trim().length > 3;
            const isDniValid = dni.length > 0;
            const isValid = isNameValid && isDniValid && terms;

            const handleSubmit = (e) => {
                if(e) e.preventDefault();
                if(isValid) {
                    onNext({ name, dni });
                } else {
                    // Activar animaci贸n en campos inv谩lidos
                    if (!isNameValid) {
                        setHighlightName(true);
                        setTimeout(() => setHighlightName(false), 600);
                    }
                    if (!isDniValid) {
                        setHighlightDni(true);
                        setTimeout(() => setHighlightDni(false), 600);
                    }
                    if (!terms) {
                        setHighlightTerms(true);
                        setTimeout(() => setHighlightTerms(false), 600);
                    }
                }
            };

            return (
                <div className="flex flex-col items-center justify-between h-full p-6 fade-enter text-center bg-white relative">
                    
                    {/* Logo Arboleda Top */}
                    <div className="w-full flex justify-center pt-8 pop-in" style={{animationDelay: '0.1s'}}>
                        <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-[4.5rem] object-contain drop-shadow-sm" style={{ filter: 'brightness(0) saturate(100%) invert(32%) sepia(85%) saturate(3015%) hue-rotate(318deg) brightness(101%) contrast(97%)' }} />
                    </div>
                    
                    {/* Icono e Instrucci贸n */}
                    <div className="flex flex-col items-center mt-2 pop-in" style={{animationDelay: '0.2s'}}>
                        <img src={ASSETS.dedoarriba} alt="Thumbs Up" className="h-10 mb-2 drop-shadow-md" />
                        <h2 className="text-[1.7rem] leading-[1.1] font-black text-[#0878A4]">
                            Primero, registremos<br/>tus datos:
                        </h2>
                    </div>
                    
                    <form className="w-full max-w-sm flex-1 flex flex-col justify-center gap-5 my-4 pop-in" style={{animationDelay: '0.3s'}} onSubmit={handleSubmit}>
                        {/* Campo Nombre */}
                        <div>
                            <label className="block text-lg font-black text-[#0878A4] mb-1">Nombre completo:</label>
                            <input 
                                type="text" 
                                required
                                value={name} onChange={e => setName(e.target.value)}
                                className={`w-full px-4 py-3 rounded-2xl border-2 text-center text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#0878A4]/50 placeholder:text-slate-400 font-semibold transition-colors ${highlightName ? 'animate-shake border-[#F9137C] bg-pink-50' : 'border-[#0878A4]'}`}
                                placeholder="Ej: Juan P茅rez Calder贸n"
                            />
                        </div>

                        {/* Campo DNI/CE */}
                        <div>
                            <label className="block text-lg font-black text-[#0878A4] mb-1">DNI/CE:</label>
                            <input 
                                type="text" 
                                required maxLength={16}
                                value={dni} onChange={e => setDni(e.target.value.replace(/[^0-9a-zA-Z]/g, ''))}
                                className={`w-full px-4 py-3 rounded-2xl border-2 text-center text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#0878A4]/50 placeholder:text-slate-400 font-semibold transition-colors ${highlightDni ? 'animate-shake border-[#F9137C] bg-pink-50' : 'border-[#0878A4]'}`}
                                placeholder="Ej: 07689324"
                            />
                        </div>
                        
                        {/* Checkbox T茅rminos */}
                        <div className={`flex items-center justify-center gap-3 mt-2 p-2 rounded-xl transition-colors ${highlightTerms ? 'animate-shake bg-pink-50' : ''}`}>
                            <button 
                                type="button" 
                                onClick={() => setTerms(!terms)}
                                className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors shrink-0 ${terms ? 'bg-[#0878A4] border-[#0878A4]' : (highlightTerms ? 'border-[#F9137C]' : 'border-[#0878A4] bg-transparent')}`}
                            >
                                {terms && <div className="w-2.5 h-2.5 rounded-full bg-white"></div>}
                            </button>
                            <label className={`text-[11px] font-semibold leading-tight text-left cursor-pointer transition-colors ${highlightTerms ? 'text-[#F9137C]' : 'text-[#0878A4]'}`} onClick={() => setTerms(!terms)}>
                                Acepto los <span onClick={(e) => {e.stopPropagation(); setShowTermsModal(true);}} className="underline font-bold cursor-pointer hover:text-[#065b7c]">T茅rminos y Condiciones</span> de la campa帽a.
                            </label>
                        </div>
                        
                        {/* Bot贸n y Flecha */}
                        <div className="flex items-center justify-center gap-4 mt-4">
                            <Button variant={isValid ? 'primary' : 'disabled'} onClick={handleSubmit} className="!w-auto px-10 uppercase text-[250%] leading-none tracking-wider py-3 rounded-2xl font-black">
                                LISTO
                            </Button>
                            
                            {/* Flecha Derecha */}
                            <div className={`text-[#F9137C] ${isValid ? 'animate-bounce-right' : 'opacity-50'}`}>
                                <svg width="24" height="40" viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M0 0L24 20L0 40V0Z" />
                                </svg>
                            </div>
                        </div>
                    </form>

                    {/* Logo Clasem Bottom */}
                    <div className="w-full flex justify-center pb-6 pop-in shrink-0" style={{animationDelay: '0.4s'}}>
                        <img src={ASSETS.logoClasem} alt="Clasem EOM" className="h-8 object-contain" />
                    </div>

                    {/* Modal T茅rminos */}
                    {showTermsModal && (
                        <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center p-4 fade-enter">
                            <div className="bg-white rounded-2xl p-6 w-full max-h-[80%] overflow-y-auto shadow-2xl">
                                <h3 className="text-xl font-bold mb-4">T茅rminos y Condiciones</h3>
                                <div className="text-sm text-slate-600 space-y-3 mb-6">
                                    <p>1. Promoci贸n v谩lida para clientes registrados de CLASEM Inmobiliaria.</p>
                                    <p>2. Cada usuario tiene un m谩ximo de 5 intentos para alcanzar el puntaje necesario.</p>
                                    <p>3. Los premios no son acumulables. Solo se entregar谩 el premio correspondiente al nivel (Tier) m谩s alto alcanzado y guardado por el usuario.</p>
                                    <p>4. El c贸digo generado al final debe ser validado por un asesor de ventas para hacer efectivo el premio durante la separaci贸n de su departamento en "La Arboleda".</p>
                                </div>
                                <Button onClick={() => setShowTermsModal(false)}>Cerrar</Button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TutorialView = ({ onNext }) => (
            <div className="flex flex-col items-center justify-between h-full p-6 fade-enter text-center bg-white relative">
                
                {/* Logo Arboleda Top */}
                <div className="w-full flex justify-center pt-8 pop-in shrink-0" style={{animationDelay: '0.1s'}}>
                    <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-[4.5rem] object-contain drop-shadow-sm" style={{ filter: 'brightness(0) saturate(100%) invert(32%) sepia(85%) saturate(3015%) hue-rotate(318deg) brightness(101%) contrast(97%)' }} />
                </div>
                
                {/* Icono e Instrucci贸n */}
                <div className="flex flex-col items-center mt-2 pop-in shrink-0" style={{animationDelay: '0.2s'}}>
                    <img src={ASSETS.foco} alt="Foco" className="h-10 mb-1 drop-shadow-md" />
                    <h2 className="text-[2rem] leading-[1.1] font-black text-[#0878A4]">
                        驴C贸mo ganas?
                    </h2>
                </div>
                
                {/* Animaci贸n del juego */}
                <div className="w-full max-w-[280px] aspect-square bg-[#f1f5f9] rounded-[2rem] relative overflow-hidden my-3 shadow-inner shrink-0 pop-in" style={{animationDelay: '0.3s'}}>
                    <MiniGamePreview />
                </div>
                
                {/* Textos */}
                <div className="w-full max-w-sm flex flex-col items-center gap-1 pop-in shrink-0" style={{animationDelay: '0.4s'}}>
                    <p className="text-[#F9137C] text-[13px] sm:text-sm font-medium leading-tight px-4">
                        Mueve el cami贸n de mudanza y<br/>atrapa todas las cajas que puedas<br/>en <strong className="font-black">30 segundos.</strong>
                    </p>
                    <p className="text-[#0878A4] text-[13px] sm:text-sm font-medium leading-tight mt-1">
                        隆Tienes <strong className="font-black">5 intentos</strong> para lograr tu mejor puntaje!
                    </p>
                </div>

                {/* Premios Horizontales */}
                <div className="flex justify-center items-end gap-6 w-full my-4 shrink-0 pop-in" style={{animationDelay: '0.5s'}}>
                    {ASSETS.prizes.map((prize, idx) => {
                        const heights = ['h-10', 'h-16', 'h-[5.5rem]']; // Escala: Micro, Lavadora, Refri
                        return (
                            <div key={prize.id} className="flex flex-col items-center">
                                <img 
                                    src={prize.image} 
                                    className={`${heights[idx]} object-contain mb-1 drop-shadow-md`} 
                                    alt={prize.name} 
                                />
                                <div className="flex items-center gap-1">
                                    <span className="text-[#F9137C] font-black text-xl leading-none">{prize.minBoxes}</span>
                                    <img src={ASSETS.caja} alt="Caja" className="h-5 object-contain" />
                                </div>
                            </div>
                        );
                    })}
                </div>

                {/* Bot贸n y Flecha */}
                <div className="flex items-center justify-center gap-4 w-full max-w-sm mt-auto mb-2 shrink-0 pop-in" style={{animationDelay: '0.6s'}}>
                    <Button onClick={onNext} className="!w-auto px-10 uppercase text-[250%] leading-none tracking-wider py-3 rounded-2xl font-black">
                        JUGAR
                    </Button>
                    
                    {/* Flecha Derecha */}
                    <div className="text-[#F9137C] animate-bounce-right shrink-0">
                        <svg width="24" height="40" viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M0 0L24 20L0 40V0Z" />
                        </svg>
                    </div>
                </div>

                {/* Logo Clasem Bottom */}
                <div className="w-full flex justify-center pb-6 pt-2 pop-in shrink-0" style={{animationDelay: '0.7s'}}>
                    <img src={ASSETS.logoClasem} alt="Clasem EOM" className="h-8 object-contain" />
                </div>
            </div>
        );

        const TransitionView = ({ attemptCount, onAnimationEnd }) => {
            useEffect(() => {
                const timer = setTimeout(onAnimationEnd, 2500);
                return () => clearTimeout(timer);
            }, [onAnimationEnd]);

            return (
                <div className="flex flex-col items-center justify-center h-full bg-[#F9137C] text-white fade-enter">
                    <div className="w-48 h-32 mb-4 bounce-in">
                        <TruckPreview />
                    </div>
                    <h2 className="text-4xl sm:text-5xl font-black text-white mb-2 uppercase text-center leading-[0.9] pop-in" style={{animationDelay: '0.1s'}}>
                        Intento<br/>{attemptCount} de {MAX_ATTEMPTS}
                    </h2>
                    <p className="text-pink-200 font-bold text-xl sm:text-2xl animate-pulse mt-4 pop-in" style={{animationDelay: '0.3s'}}>
                        隆PREPRATE!
                    </p>
                </div>
            );
        };

        const getPrizeForScore = (score) => {
            // Evaluamos desde el m谩s alto (Tier 3) al m谩s bajo
            for (let i = ASSETS.prizes.length - 1; i >= 0; i--) {
                if (score >= ASSETS.prizes[i].minBoxes) {
                    return ASSETS.prizes[i];
                }
            }
            return null; // Ning煤n premio
        };

        const ResultView = ({ score, attemptCount, attemptsArr, onRetry, onClaim }) => {
            // Calculamos el mejor r茅cord hist贸rico ANTERIOR al intento actual
            const previousAttempts = attemptsArr.slice(0, -1);
            const previousBestScore = previousAttempts.length > 0 ? Math.max(...previousAttempts) : 0;
            const previousBestPrize = getPrizeForScore(previousBestScore);
            
            const currentPrize = getPrizeForScore(score);
            const attemptsLeft = MAX_ATTEMPTS - attemptCount;

            // Determina si estamos manteniendo un premio mejor/igual o ganando uno nuevo
            const isMaintaining = previousBestPrize !== null && (!currentPrize || previousBestPrize.minBoxes >= currentPrize.minBoxes);
            const displayPrize = isMaintaining ? previousBestPrize : currentPrize;
            
            const getArticle = (name) => {
                const n = name.toLowerCase();
                return n.includes('lavadora') || n.includes('refrigeradora') ? 'UNA' : 'UN';
            };

            return (
                <div className="flex flex-col h-full p-6 fade-enter text-center items-center justify-between bg-white relative">
                    
                    {/* Logo Arboleda Top */}
                    <div className="w-full flex justify-center pt-8 pop-in shrink-0" style={{animationDelay: '0.1s'}}>
                        <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-16 object-contain drop-shadow-sm" style={{ filter: 'brightness(0) saturate(100%) invert(32%) sepia(85%) saturate(3015%) hue-rotate(318deg) brightness(101%) contrast(97%)' }} />
                    </div>

                    <div className="flex flex-col items-center justify-center w-full flex-1">
                        
                        {/* Atrapaste Title */}
                        <div className="pop-in" style={{animationDelay:'0.2s'}}>
                            <h2 className="text-[2rem] font-black text-[#F9137C] leading-none mb-1">
                                Atrapaste
                            </h2>
                            <div className="flex items-center justify-center gap-2">
                                <img src={ASSETS.caja} alt="Caja" className="h-10 object-contain" />
                                <span className="text-5xl font-black text-[#F9137C]">{score < 10 ? `0${score}` : score}</span>
                            </div>
                        </div>
                        
                        {/* Prize Image & Background Wheel */}
                        <div className="relative w-full flex justify-center items-center my-6 min-h-[220px] max-h-[280px]">
                            {/* Rueda giratoria con tinte magenta y opacity suave */}
                            <img src={ASSETS.rueda} className="absolute w-[110%] max-w-[400px] spin-slow z-0 pop-in opacity-20" style={{animationDelay: '0.3s', filter: 'brightness(0) saturate(100%) invert(32%) sepia(85%) saturate(3015%) hue-rotate(318deg) brightness(101%) contrast(97%)'}} alt="Fondo Animado" />
                            
                            {/* Prize Image o Caja triste si no gan贸 nada */}
                            {displayPrize ? (
                                <img src={displayPrize.image} className="relative h-[180px] object-contain drop-shadow-2xl pop-in z-10 bounce-in" style={{animationDelay: '0.4s'}} alt="Premio" />
                            ) : (
                                <div className="relative z-10 text-6xl bounce-in" style={{animationDelay: '0.4s'}}></div>
                            )}
                        </div>

                        {/* Title Ganaste / Mantienes */}
                        <div className="pop-in mb-4" style={{animationDelay:'0.5s'}}>
                            {displayPrize ? (
                                <h3 className="text-[1.7rem] sm:text-3xl font-black text-[#0878A4] leading-[1.1] uppercase px-4">
                                    {isMaintaining ? (
                                        <>隆MANTIENES TU<br/>{displayPrize.name}!</>
                                    ) : (
                                        <>隆GANASTE {getArticle(displayPrize.name)}<br/>{displayPrize.name}!</>
                                    )}
                                </h3>
                            ) : (
                                <h3 className="text-[1.7rem] sm:text-3xl font-black text-[#0878A4] leading-[1.1] uppercase px-4">
                                    隆SIGUE<br/>INTENTANDO!
                                </h3>
                            )}
                        </div>
                    </div>

                    {/* Botones */}
                    <div className="w-full flex flex-col gap-4 mt-auto pb-4 shrink-0 pop-in" style={{animationDelay:'0.6s'}}>
                        {attemptsLeft > 0 ? (
                            <>
                                {/* Jugar (Izquierda) */}
                                <div className="flex items-center justify-center gap-3 w-full max-w-[340px] mx-auto">
                                    <div className="text-[#0878A4] animate-bounce-left shrink-0">
                                        <svg width="20" height="32" viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M24 0L0 20L24 40V0Z" />
                                        </svg>
                                    </div>
                                    <Button onClick={onRetry} className="!w-full !bg-[#0878A4] hover:!bg-[#065b7c] flex-1 px-2 uppercase text-xl sm:text-2xl leading-none tracking-wider py-4 rounded-2xl font-black shadow-lg">
                                        JUGAR ({attemptsLeft} INTENTOS)
                                    </Button>
                                    <div className="w-[20px] shrink-0"></div> {/* Spacer balance */}
                                </div>
                                
                                {/* Reclamar (Derecha) */}
                                {displayPrize && (
                                    <div className="flex items-center justify-center gap-3 w-full max-w-[340px] mx-auto">
                                        <div className="w-[20px] shrink-0"></div> {/* Spacer balance */}
                                        <Button onClick={onClaim} className="!w-full flex-1 px-2 uppercase text-xl sm:text-2xl leading-none tracking-wider py-4 rounded-2xl font-black shadow-lg">
                                            RECLAMAR MI PREMIO
                                        </Button>
                                        <div className="text-[#F9137C] animate-bounce-right shrink-0">
                                            <svg width="20" height="32" viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M0 0L24 20L0 40V0Z" />
                                            </svg>
                                        </div>
                                    </div>
                                )}
                            </>
                        ) : (
                            <div className="flex items-center justify-center gap-3 w-full max-w-[340px] mx-auto">
                                <Button onClick={onClaim} className="!w-full px-10 uppercase text-3xl leading-none tracking-wider py-4 rounded-2xl font-black">
                                    CONTINUAR
                                </Button>
                                <div className="text-[#F9137C] animate-bounce-right shrink-0">
                                    <svg width="20" height="32" viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 0L24 20L0 40V0Z" />
                                    </svg>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Logo Clasem Bottom */}
                    <div className="w-full flex justify-center pb-6 pt-2 pop-in shrink-0" style={{animationDelay: '0.7s'}}>
                        <img src={ASSETS.logoClasem} alt="Clasem EOM" className="h-8 object-contain" />
                    </div>
                </div>
            );
        };

        const WinnerView = ({ userData, bestScore, uniqueCode }) => {
            const finalPrize = getPrizeForScore(bestScore);

            return (
                <div className="flex flex-col items-center h-full p-8 fade-enter text-center bg-gradient-to-b from-[#0878A4] to-[#044059] text-white overflow-y-auto">
                    <div className="w-full flex justify-between items-center mb-6 shrink-0 pt-4">
                        <div className="bg-white px-3 py-1.5 rounded-xl">
                            <img src={ASSETS.logoClasem} alt="Clasem" className="h-5 object-contain" />
                        </div>
                        <img src={ASSETS.logoArboleda} className="h-6 object-contain" alt="Logo" />
                    </div>
                    
                    {finalPrize ? (
                        <>
                            <div className="text-xs font-bold uppercase tracking-widest text-blue-200 mb-2">隆Felicidades!</div>
                            <h2 className="text-3xl font-extrabold mb-6">Eres el ganador de:</h2>
                            
                            <div className="relative w-full aspect-square max-w-xs mx-auto bounce-in">
                                <div className="absolute inset-0 bg-white/20 rounded-full blur-3xl"></div>
                                <img src={finalPrize.image} className="w-full h-full object-contain relative z-10 drop-shadow-2xl" alt={finalPrize.name} />
                            </div>
                            
                            <h3 className="text-4xl font-black text-[#F9137C] mt-2 mb-8 drop-shadow-md">{finalPrize.name}</h3>
                            
                            <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 w-full border border-white/20">
                                <p className="text-sm text-blue-100 mb-1">CDIGO DE GANADOR</p>
                                <div className="text-3xl font-mono font-bold tracking-wider bg-white text-[#F9137C] py-2 rounded-lg my-2 select-all">
                                    {uniqueCode}
                                </div>
                                <p className="text-xs text-blue-100 mt-3 px-2">
                                    T贸male un screenshot a esta pantalla y pres茅ntalo a tu asesor al separar tu depa.
                                </p>
                            </div>
                        </>
                    ) : (
                        <div className="flex-1 flex flex-col items-center justify-center">
                            <div className="text-6xl mb-6 opacity-80"></div>
                            <h2 className="text-3xl font-extrabold mb-4">隆Gracias por jugar!</h2>
                            <p className="text-blue-100 px-4">Esta vez no lograste alcanzar el puntaje m铆nimo, pero tenemos grandes descuentos esper谩ndote en caseta de ventas.</p>
                        </div>
                    )}
                    
                    <div className="text-xs text-white/50 mt-10 mb-4 font-mono">
                        {userData.name} | DNI: {userData.dni}
                    </div>
                </div>
            );
        };

        // --- CONTROLADOR PRINCIPAL (APP) ---
        const App = () => {
            // Estados de vista: SPLASH, REGISTER, TUTORIAL, TRANSITION, GAME, RESULT, WINNER
            const [view, setView] = useState('SPLASH');
            
            // Datos del jugador
            const [userData, setUserData] = useState({ name: '', dni: '' });
            const [attempts, setAttempts] = useState([]); // Array de puntajes
            const [uniqueCode, setUniqueCode] = useState('');

            // Inicializar DB en el montaje
            useEffect(() => {
                DBService.init();
            }, []);

            const currentAttemptCount = attempts.length + 1;
            const bestScore = attempts.length > 0 ? Math.max(...attempts) : 0;

            const generateCode = () => {
                return 'ARB-' + Math.random().toString(36).substring(2, 7).toUpperCase();
            };

            const finalizeGame = async () => {
                const code = generateCode();
                setUniqueCode(code);
                
                const finalPrize = getPrizeForScore(bestScore);
                
                // Guardar en DB (Mock o Real)
                await DBService.savePlayerResult({
                    playerName: userData.name,
                    playerDni: userData.dni,
                    bestScore: bestScore,
                    prizeWon: finalPrize ? finalPrize.name : 'Ninguno',
                    uniqueCode: finalPrize ? code : 'N/A',
                    attempts: attempts
                });

                setView('WINNER');
            };

            const handleGameOver = (score) => {
                const newAttempts = [...attempts, score];
                setAttempts(newAttempts);
                
                const achievedPrize = getPrizeForScore(score);
                
                // Si alcanz贸 el premio m谩ximo (Tier 3), terminamos autom谩ticamente
                if (achievedPrize && achievedPrize.id === 'tier3') {
                    // Esperar un segundito para que el estado se actualice bien antes de ir a Winner
                    setTimeout(() => {
                        const code = generateCode();
                        setUniqueCode(code);
                        DBService.savePlayerResult({
                            playerName: userData.name,
                            playerDni: userData.dni,
                            bestScore: Math.max(...newAttempts),
                            prizeWon: 'Refrigeradora',
                            uniqueCode: code,
                            attempts: newAttempts
                        }).then(() => setView('WINNER'));
                    }, 500);
                } else {
                    setView('RESULT');
                }
            };

            return (
                <div className="app-container">
                    {view === 'SPLASH' && (
                        <SplashView onNext={() => setView('REGISTER')} />
                    )}
                    
                    {view === 'REGISTER' && (
                        <RegisterView onNext={(data) => {
                            setUserData(data);
                            setView('TUTORIAL');
                        }} />
                    )}
                    
                    {view === 'TUTORIAL' && (
                        <TutorialView onNext={() => setView('TRANSITION')} />
                    )}

                    {view === 'TRANSITION' && (
                        <TransitionView 
                            attemptCount={currentAttemptCount} 
                            onAnimationEnd={() => setView('GAME')} 
                        />
                    )}

                    {view === 'GAME' && (
                        <div className="h-full w-full fade-enter">
                            <GameEngine onGameOver={handleGameOver} />
                        </div>
                    )}

                    {view === 'RESULT' && (
                        <ResultView 
                            score={attempts[attempts.length - 1]}
                            bestScore={bestScore}
                            attemptCount={attempts.length}
                            attemptsArr={attempts}
                            onRetry={() => setView('TRANSITION')}
                            onClaim={finalizeGame}
                        />
                    )}

                    {view === 'WINNER' && (
                        <WinnerView 
                            userData={userData}
                            bestScore={bestScore}
                            uniqueCode={uniqueCode}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
