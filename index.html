<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La Arboleda - Juego de Premios</title>
    
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (v11) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase to the global scope for React to use
        window.FirebaseAPI = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, serverTimestamp };
    </script>

    <style>
        /* Custom Animations & Styles */
        body { margin: 0; overflow: hidden; background-color: #ffffff; font-family: 'Montserrat', sans-serif; touch-action: none; }
        .app-container { max-width: 480px; margin: 0 auto; height: 100vh; height: 100dvh; position: relative; overflow: hidden; background-color: #ffffff; box-shadow: 0 0 40px rgba(0,0,0,0.1); }
        
        .fade-enter { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .bounce-in { animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
        
        /* Nuevas Animaciones para Splashscreen y Transiciones */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        .pop-in { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; }
        
        @keyframes spinSlow { 100% { transform: rotate(360deg); } }
        .spin-slow { animation: spinSlow 20s linear infinite; }

        @keyframes bounceDown { 
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(8px); }
        }
        .animate-bounce-down { animation: bounceDown 1.5s ease-in-out infinite; }

        @keyframes bounceRight {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(8px); }
        }
        .animate-bounce-right { animation: bounceRight 1.5s ease-in-out infinite; }

        @keyframes bounceLeft {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-8px); }
        }
        .animate-bounce-left { animation: bounceLeft 1.5s ease-in-out infinite; }

        /* Nueva Animaci贸n de Error/Sacudida */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        /* Animaciones del Juego */
        @keyframes scorePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.6); }
            100% { transform: scale(1); }
        }
        .score-pop { animation: scorePop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-block; }

        @keyframes warningPulse {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.35; }
        }
        .animate-warning-pulse { animation: warningPulse 1s ease-in-out infinite; }

        /* Ocultar scrollbars */
        ::-webkit-scrollbar { display: none; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .text-brand { color: #0878A4; } /* Azul Inmobiliaria */
        .text-accent { color: #F9137C; } /* Rosa Resaltado */
        .bg-brand { background-color: #F9137C; color: #ffffff; } /* Rosa para botones */
        .bg-brand:hover { background-color: #d80b68; }
        .bg-primary { background-color: #0878A4; } /* Azul para fondos */
        
        canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIGURACIN Y ASSETS ---
        const ASSETS = {
            logoClasem: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/logoclasem.png?raw=true',
            logoArboleda: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/logoarboleda.png?raw=true',
            rueda: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/rueda.png?raw=true',
            rueda2: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/rueda2.png?raw=true',
            bodegon: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/bodegon.png?raw=true',
            dedoarriba: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/dedoarriba.webp?raw=true',
            caja: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/caja.webp?raw=true',
            foco: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/foco.webp?raw=true',
            fondo: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/fondo.png?raw=true',
            timer: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/timer.png?raw=true',
            camara: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/camara.webp?raw=true',
            beep: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/beep.mp3?raw=true',
            prizes: [
                { id: 'tier1', name: 'Microondas', minBoxes: 15, image: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/microondas.png?raw=true' },
                { id: 'tier2', name: 'Lavadora', minBoxes: 25, image: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/lavadora.png?raw=true' },
                { id: 'tier3', name: 'Refrigeradora', minBoxes: 35, image: 'https://github.com/nsanchezBG/LaArboledaClasemEOM/blob/main/refri.webp?raw=true' }
            ]
        };

        const MAX_ATTEMPTS = 5;
        const GAME_DURATION = 30; // Segundos
        
        // --- CONFIGURACIN DE DIFICULTAD ---
        // Segundos entre cada caja. 
        // Aumenta este n煤mero para que caigan MENOS cajas (m谩s dif铆cil).
        // Disminuye este n煤mero para que caigan MS cajas (m谩s f谩cil).
        // (En 0.8, caer谩n un m谩ximo de ~37 cajas en toda la partida de 30 segs)
        const BOX_SPAWN_INTERVAL = 0.8; 

        // --- SISTEMA DE BASE DE DATOS (MOCK / FIREBASE) ---
        // Preparado para Looker Studio con estructura plana
        const DBService = {
            db: null,
            user: null,
            isMock: true,
            
            async init() {
                try {
                    // Intenta inicializar Firebase si existe la configuraci贸n (en producci贸n)
                    if (typeof window.FirebaseAPI !== 'undefined' && typeof __firebase_config !== 'undefined' && __firebase_config) {
                        const config = JSON.parse(__firebase_config);
                        const app = window.FirebaseAPI.initializeApp(config);
                        const auth = window.FirebaseAPI.getAuth(app);
                        this.db = window.FirebaseAPI.getFirestore(app);
                        
                        // Autenticaci贸n asegurada con Custom Token
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await window.FirebaseAPI.signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await window.FirebaseAPI.signInAnonymously(auth);
                        }
                        
                        // Escuchar estado de auth
                        window.FirebaseAPI.onAuthStateChanged(auth, (user) => {
                            if (user) this.user = user;
                        });

                        this.user = auth.currentUser;
                        this.isMock = false;
                        console.log("Firebase conectado correctamente.");
                    } else {
                        console.log("Modo Demo: Base de datos desconectada (Mock).");
                    }
                } catch (error) {
                    console.log("Modo Demo: Usando base de datos local (Mock). Error:", error);
                }
            },

            async savePlayerResult(data) {
                if (!this.isMock && !this.user) {
                    console.error("Error guardando: Usuario no autenticado.");
                    return false;
                }

                const payload = {
                    ...data,
                    userId: this.user ? this.user.uid : 'mock-user-id',
                    attemptsDetails: JSON.stringify(data.attempts), // Array stringified for Looker Studio flat schema
                    timestamp: this.isMock ? new Date().toISOString() : window.FirebaseAPI.serverTimestamp(),
                };

                if (this.isMock) {
                    console.log(" [Mock DB] Datos guardados:", payload);
                    return true;
                } else {
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        // Guardamos en un path p煤blico para f谩cil recolecci贸n desde Looker Studio
                        const colRef = window.FirebaseAPI.collection(this.db, 'artifacts', appId, 'public', 'data', 'arboleda_winners');
                        await window.FirebaseAPI.addDoc(colRef, payload);
                        return true;
                    } catch (e) {
                        console.error("Error guardando en Firestore:", e);
                        return false;
                    }
                }
            }
        };

        // --- COMPONENTES UI REUTILIZABLES ---
        const TopBrandBar = () => (
            <div className="w-full flex justify-between items-center mb-6 shrink-0 pt-4 px-2">
                <img src={ASSETS.logoClasem} alt="Clasem" className="h-6 object-contain drop-shadow-sm" />
                <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-6 object-contain drop-shadow-sm" />
            </div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = '' }) => {
            const baseClass = "w-full rounded-xl font-bold transition-transform transform active:scale-95 shadow-lg flex justify-center items-center gap-2";
            const variants = {
                primary: "bg-brand text-white hover:bg-pink-700",
                secondary: "bg-white text-accent border-2 border-[#F9137C] hover:bg-pink-50",
                disabled: "bg-[#F9137C] opacity-50 text-white cursor-not-allowed shadow-none"
            };
            return (
                <button onClick={onClick} className={`${baseClass} ${variants[variant]} ${className}`} disabled={variant === 'disabled'}>
                    {children}
                </button>
            );
        };

        // --- FUNCIONES DE DIBUJO COMPARTIDAS ---
        const drawTruckShape = (ctx, x, y, w, h, logoImg) => {
            ctx.fillStyle = '#0878A4'; // Cabina Azul
            ctx.beginPath();
            ctx.roundRect(x + w*0.7, y + h*0.2, w*0.3, h*0.8, 5);
            ctx.fill();
            
            ctx.fillStyle = '#e2e8f0'; // Ventana
            ctx.fillRect(x + w*0.75, y + h*0.3, w*0.2, h*0.3);

            ctx.fillStyle = '#f8fafc'; // Caja trasera (blanca)
            ctx.beginPath();
            ctx.roundRect(x, y, w*0.75, h, 8);
            ctx.fill();
            
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Llantas
            ctx.fillStyle = '#1e293b';
            ctx.beginPath();
            ctx.arc(x + w*0.2, y + h, 12, 0, Math.PI * 2);
            ctx.arc(x + w*0.8, y + h, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#cbd5e1'; // rines
            ctx.beginPath();
            ctx.arc(x + w*0.2, y + h, 5, 0, Math.PI * 2);
            ctx.arc(x + w*0.8, y + h, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // Logo pintado en el cami贸n (Livery)
            if (logoImg && logoImg.complete && logoImg.naturalWidth !== 0) {
                const logoW = w * 0.55;
                const aspect = logoImg.naturalHeight / logoImg.naturalWidth;
                const logoH = logoW * aspect;
                ctx.drawImage(logoImg, x + (w*0.75)/2 - logoW/2, y + h/2 - logoH/2, logoW, logoH);
            } else {
                ctx.fillStyle = '#0878A4';
                ctx.font = 'bold 10px sans-serif';
                ctx.fillText('CLASEM', x + 5, y + h/2 + 5);
            }
        };

        const drawBoxShape = (ctx, x, y, size, boxImg) => {
            if (boxImg && boxImg.complete && boxImg.naturalWidth !== 0) {
                ctx.drawImage(boxImg, x, y, size, size);
            } else {
                ctx.fillStyle = '#d97706'; // Color cart贸n
                ctx.fillRect(x, y, size, size);
                ctx.fillStyle = '#b45309'; // Cinta adhesiva
                ctx.fillRect(x + size/2 - 2, y, 4, size);
                ctx.fillRect(x, y + size/2 - 2, size, 4);
                // S铆mbolo
                ctx.fillStyle = '#fef3c7';
                ctx.font = `${Math.floor(size*0.45)}px sans-serif`;
                ctx.fillText('', x + size*0.1, y + size - size*0.15);
            }
        };

        // --- COMPONENTE CAMIN DE CARGA (TRANSICIN) ---
        const TruckPreview = () => {
            const canvasRef = useRef(null);
            const logoImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.logoClasem;
                return img;
            }, []);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;
                let lastTime = Date.now();

                const resize = () => {
                    const size = canvas.parentElement.clientWidth;
                    canvas.width = size;
                    canvas.height = size * 0.6;
                };
                resize();
                window.addEventListener('resize', resize);

                const truck = { width: 150, height: 90, x: canvas.width/2 - 75, y: canvas.height/2 - 45 };

                const loop = () => {
                    const now = Date.now();
                    lastTime = now;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Animaci贸n de flotaci贸n suave simulando marcha
                    const floatY = Math.sin(now / 200) * 8;

                    ctx.save();
                    ctx.translate(0, floatY);
                    drawTruckShape(ctx, truck.x, truck.y, truck.width, truck.height, logoImg);
                    ctx.restore();

                    animationId = requestAnimationFrame(loop);
                };
                animationId = requestAnimationFrame(loop);

                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', resize);
                };
            }, [logoImg]);

            return <canvas ref={canvasRef} className="w-full h-full drop-shadow-2xl"></canvas>;
        };

        // --- COMPONENTE MINI-TUTORIAL (SIMULACIN DE MOTOR) ---
        const MiniGamePreview = () => {
            const canvasRef = useRef(null);
            const logoImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.logoClasem;
                return img;
            }, []);
            const boxImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.caja;
                return img;
            }, []);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;
                let lastTime = Date.now();

                const resize = () => {
                    // Obligamos a que la resoluci贸n interna sea 1:1 (cuadrada)
                    const size = canvas.parentElement.clientWidth || 280;
                    canvas.width = size;
                    canvas.height = size;
                };
                resize();
                window.addEventListener('resize', resize);

                const truck = { width: 70, height: 42, x: canvas.width/2 - 35, y: canvas.height - 50 };
                const boxes = [];
                let boxSpawnTimer = 0;
                let truckInflate = 0;

                const loop = () => {
                    const now = Date.now();
                    const dt = (now - lastTime) / 1000;
                    lastTime = now;

                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#0878A410'; 
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#cbd5e1';
                    ctx.fillRect(0, canvas.height - 15, canvas.width, 15);

                    // Auto move truck smoothly with sine wave
                    truck.x = (canvas.width / 2 - truck.width/2) + Math.sin(now / 500) * (canvas.width/2 - truck.width);
                    truck.y = canvas.height - truck.height - 10;

                    truckInflate = Math.max(0, truckInflate - dt * 6);

                    boxSpawnTimer -= dt;
                    if (boxSpawnTimer <= 0) {
                        boxes.push({ x: Math.random() * (canvas.width - 25), y: -30, size: 25, speed: 120 });
                        boxSpawnTimer = 0.8;
                    }

                    for (let i = boxes.length - 1; i >= 0; i--) {
                        let b = boxes[i];
                        b.y += b.speed * dt;

                        if (b.y + b.size > truck.y && b.y < truck.y + truck.height && b.x + b.size > truck.x && b.x < truck.x + truck.width) {
                            truckInflate = 1;
                            boxes.splice(i, 1);
                            continue;
                        }
                        if (b.y > canvas.height) {
                            boxes.splice(i, 1);
                            continue;
                        }
                        drawBoxShape(ctx, b.x, b.y, b.size, boxImg);
                    }

                    const scale = 1 + truckInflate * 0.15;
                    ctx.save();
                    ctx.translate(truck.x + truck.width/2, truck.y + truck.height/2);
                    ctx.scale(scale, scale);
                    drawTruckShape(ctx, -truck.width/2, -truck.height/2, truck.width, truck.height, logoImg);
                    ctx.restore();

                    animationId = requestAnimationFrame(loop);
                };
                animationId = requestAnimationFrame(loop);

                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', resize);
                };
            }, [logoImg]);

            return <canvas ref={canvasRef} className="w-full h-full rounded-3xl"></canvas>;
        };

        // --- MOTOR DEL JUEGO (CANVAS) ---
        const GameEngine = ({ onGameOver }) => {
            const canvasRef = useRef(null);
            const scoreSpanRef = useRef(null);
            const [timeLeft, setTimeLeft] = useState(GAME_DURATION);
            const [score, setScore] = useState(0);
            const [showTimeUp, setShowTimeUp] = useState(false);
            
            // Precargas
            const logoImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.logoClasem;
                return img;
            }, []);
            
            const boxImg = useMemo(() => {
                const img = new Image();
                img.src = ASSETS.caja;
                return img;
            }, []);

            const beepAudio = useMemo(() => new Audio(ASSETS.beep), []);

            useEffect(() => {
                beepAudio.load();
            }, [beepAudio]);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;
                let lastTime = Date.now();
                
                const resize = () => {
                    canvas.width = canvas.parentElement.clientWidth;
                    canvas.height = canvas.parentElement.clientHeight;
                };
                resize();
                window.addEventListener('resize', resize);

                let gameTime = GAME_DURATION;
                let boxesCaught = 0;
                let isFinished = false;
                
                const truck = {
                    width: 130,
                    height: 78,
                    x: canvas.width / 2 - 65,
                    y: canvas.height - 100,
                    color: '#0878A4'
                };

                const boxes = [];
                let boxSpawnTimer = 0;
                let truckInflate = 0;
                let particles = [];

                const handleMove = (e) => {
                    let clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const rect = canvas.getBoundingClientRect();
                    let targetX = clientX - rect.left - truck.width / 2;
                    if (targetX < 0) targetX = 0;
                    if (targetX > canvas.width - truck.width) targetX = canvas.width - truck.width;
                    truck.x = targetX;
                };

                canvas.addEventListener('touchmove', handleMove, { passive: true });
                canvas.addEventListener('mousemove', handleMove);

                const gameLoop = () => {
                    if (isFinished) return;

                    const now = Date.now();
                    const dt = (now - lastTime) / 1000;
                    lastTime = now;

                    gameTime -= dt;
                    if (gameTime <= 0) {
                        isFinished = true;
                        setTimeLeft(0);
                        setShowTimeUp(true);
                        setTimeout(() => {
                            onGameOver(boxesCaught);
                        }, 2000);
                        return;
                    }
                    setTimeLeft(Math.ceil(gameTime));

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    boxSpawnTimer -= dt;
                    if (boxSpawnTimer <= 0) {
                        boxes.push({
                            x: Math.random() * (canvas.width - 50),
                            y: -50,
                            size: 45,
                            speed: 150 + Math.random() * 100
                        });
                        boxSpawnTimer = BOX_SPAWN_INTERVAL;
                    }

                    truckInflate = Math.max(0, truckInflate - dt * 6);

                    for (let i = boxes.length - 1; i >= 0; i--) {
                        let b = boxes[i];
                        b.y += b.speed * dt;
                        
                        if (
                            b.y + b.size > truck.y &&
                            b.y < truck.y + truck.height &&
                            b.x + b.size > truck.x &&
                            b.x < truck.x + truck.width
                        ) {
                            boxesCaught++;
                            setScore(boxesCaught);
                            boxes.splice(i, 1);

                            truckInflate = 1;
                            for(let p = 0; p < 8; p++) {
                                particles.push({
                                    x: truck.x + truck.width / 2,
                                    y: truck.y,
                                    vx: (Math.random() - 0.5) * 300,
                                    vy: (Math.random() - 1) * 300,
                                    life: 1
                                });
                            }

                            beepAudio.currentTime = 0;
                            beepAudio.play().catch(e => console.log('Audio autoplay prevented'));

                            if (scoreSpanRef.current) {
                                scoreSpanRef.current.classList.remove('score-pop');
                                void scoreSpanRef.current.offsetWidth;
                                scoreSpanRef.current.classList.add('score-pop');
                            }
                            
                            continue;
                        }

                        if (b.y > canvas.height) {
                            boxes.splice(i, 1);
                            continue;
                        }

                        drawBoxShape(ctx, b.x, b.y, b.size, boxImg);
                    }

                    for (let i = particles.length - 1; i >= 0; i--) {
                        let p = particles[i];
                        p.x += p.vx * dt;
                        p.y += p.vy * dt;
                        p.vy += 800 * dt; 
                        p.life -= dt * 1.5;
                        
                        if (p.life <= 0) {
                            particles.splice(i, 1);
                        } else {
                            ctx.fillStyle = `rgba(249, 19, 124, ${p.life})`;
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }

                    truck.y = canvas.height - truck.height - 20;
                    // Dibujar cami贸n
                    // Actualizar Y por si cambi贸 el resize
                    truck.y = canvas.height - truck.height - 20;
                    
                    const scale = 1 + truckInflate * 0.15;
                    ctx.save();
                    ctx.translate(truck.x + truck.width/2, truck.y + truck.height/2);
                    ctx.scale(scale, scale);
                    drawTruckShape(ctx, -truck.width/2, -truck.height/2, truck.width, truck.height, logoImg);
                    ctx.restore();

                    animationId = requestAnimationFrame(gameLoop);
                };

                animationId = requestAnimationFrame(gameLoop);

                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', resize);
                    canvas.removeEventListener('touchmove', handleMove);
                    canvas.removeEventListener('mousemove', handleMove);
                };
            }, [onGameOver, beepAudio]);

            return (
                <div className="relative w-full h-full bg-cover bg-center overflow-hidden" style={{backgroundImage: `url(${ASSETS.fondo})`}}>
                    
                    {timeLeft <= 5 && !showTimeUp && (
                        <div className="absolute inset-0 bg-[#F9137C] z-20 pointer-events-none animate-warning-pulse"></div>
                    )}

                    <div className="absolute top-8 left-0 right-0 px-6 flex justify-between items-center z-30 pointer-events-none">
                        
                        <div className="flex items-center gap-2">
                            <img src={ASSETS.timer} className="h-10 object-contain drop-shadow-md" alt="Timer" />
                            <span className="font-black text-[2.5rem] text-[#0878A4] drop-shadow-sm leading-none mt-1.5">{timeLeft < 10 ? `0${timeLeft}` : timeLeft}</span>
                        </div>

                        <img src={ASSETS.logoArboleda} className="h-12 object-contain drop-shadow-md" alt="Logo" />
                        
                        <div className="flex items-center gap-2">
                            <img src={ASSETS.caja} className="h-9 object-contain drop-shadow-md" alt="Caja" />
                            <span ref={scoreSpanRef} className="font-black text-[2.5rem] text-[#F9137C] drop-shadow-sm leading-none mt-1.5">{score < 10 ? `0${score}` : score}</span>
                        </div>
                    </div>
                    
                    <canvas ref={canvasRef} className="absolute inset-0 w-full h-full cursor-none z-10"></canvas>
                    
                    {showTimeUp && (
                        <div className="absolute inset-0 bg-[#F9137C] z-50 flex items-center justify-center fade-enter">
                            <h2 className="text-[4.5rem] font-black text-white uppercase tracking-wider bounce-in drop-shadow-xl">
                                隆TIEMPO!
                            </h2>
                        </div>
                    )}
                </div>
            );
        };

        // --- PANTALLAS (VIEWS) - SOLUCIN ZERO-SCROLL ---
        // Uso estricto de overflow-hidden, flex-1, y unidades relativas (dvh, clamp) 
        // para asegurar encaje perfecto en cualquier celular sin importar barras del navegador.

        const SplashView = ({ onNext }) => (
            <div className="h-full w-full overflow-hidden bg-white fade-enter relative">
                <div className="flex flex-col items-center justify-between h-full w-full px-4 sm:px-6 py-[3dvh]" style={{ paddingBottom: 'max(2dvh, env(safe-area-inset-bottom))', paddingTop: 'max(2dvh, env(safe-area-inset-top))' }}>
                    
                    {/* Logo Arboleda Top */}
                    <div className="w-full flex justify-center pop-in shrink-0 h-[7dvh] max-h-[70px]" style={{animationDelay: '0.1s'}}>
                        <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-full object-contain drop-shadow-sm" />
                    </div>
                    
                    {/* Titles */}
                    <div className="pop-in shrink-0 mt-[1dvh]" style={{animationDelay: '0.2s'}}>
                        <h1 className="text-[clamp(1.5rem,4dvh,2.5rem)] font-black text-[#0878A4] leading-[0.85] uppercase tracking-tight text-center">
                            隆AMUEBLA TU<br/>NUEVO HOGAR!
                        </h1>
                    </div>

                    {/* Bodeg贸n Unificado con Rueda */}
                    <div className="relative w-full flex-1 flex flex-col justify-center items-center min-h-0 shrink my-[1dvh]">
                        <img src={ASSETS.rueda} className="absolute h-[120%] max-h-[35dvh] spin-slow z-0 pop-in opacity-80 object-contain" style={{animationDelay: '0.3s'}} alt="Fondo Animado" />
                        <img src={ASSETS.bodegon} className="relative h-full max-h-[30dvh] w-auto max-w-[95%] object-contain drop-shadow-2xl pop-in z-10" style={{animationDelay: '0.4s'}} alt="Premios" />
                    </div>

                    {/* Text & CTA */}
                    <div className="w-full flex flex-col items-center pop-in z-20 shrink-0" style={{animationDelay: '0.5s'}}>
                        <h2 className="text-[#F9137C] font-bold text-[clamp(1rem,2dvh,1.5rem)] leading-[0.9] mb-[0.5dvh] text-center">
                            Juega y ll茅vate un<br/>electrodom茅stico
                        </h2>
                        <h1 className="text-[#F9137C] font-black text-[clamp(2.5rem,6dvh,4rem)] uppercase mb-[1dvh] tracking-wide leading-[0.8]">
                            GRATIS
                        </h1>
                        
                        {/* Bouncing Arrow */}
                        <div className="animate-bounce-down mb-[1.5dvh] text-[#F9137C] h-[3dvh] max-h-[30px]">
                            <svg viewBox="0 0 40 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" className="h-full w-auto">
                                <path d="M20 24L0 0H40L20 24Z" />
                            </svg>
                        </div>

                        <Button onClick={onNext} className="!py-[1.5dvh] uppercase text-[clamp(1.8rem,4.5dvh,3rem)] leading-none tracking-wider rounded-[2dvh] w-[90%] max-w-sm font-black">
                            PARTICIPAR
                        </Button>
                    </div>

                    {/* Logo Clasem Bottom */}
                    <div className="w-full flex justify-center pop-in shrink-0 mt-[2dvh] h-[3.5dvh] max-h-[35px]" style={{animationDelay: '0.6s'}}>
                        <img src={ASSETS.logoClasem} alt="Clasem EOM" className="h-full object-contain" />
                    </div>
                </div>
            </div>
        );

        const RegisterView = ({ onNext }) => {
            const [name, setName] = useState('');
            const [dni, setDni] = useState('');
            const [terms, setTerms] = useState(false);
            const [showTermsModal, setShowTermsModal] = useState(false);
            const [highlightTerms, setHighlightTerms] = useState(false);
            const [highlightName, setHighlightName] = useState(false);
            const [highlightDni, setHighlightDni] = useState(false);

            const isNameValid = name.trim().length > 3;
            const isDniValid = dni.length > 0;
            const isValid = isNameValid && isDniValid && terms;

            const handleSubmit = (e) => {
                if(e) e.preventDefault();
                if(isValid) {
                    onNext({ name, dni });
                } else {
                    if (!isNameValid) {
                        setHighlightName(true);
                        setTimeout(() => setHighlightName(false), 600);
                    }
                    if (!isDniValid) {
                        setHighlightDni(true);
                        setTimeout(() => setHighlightDni(false), 600);
                    }
                    if (!terms) {
                        setHighlightTerms(true);
                        setTimeout(() => setHighlightTerms(false), 600);
                    }
                }
            };

            return (
                <div className="h-full w-full overflow-hidden bg-white fade-enter relative">
                    <div className="flex flex-col items-center justify-between h-full w-full px-4 sm:px-6 py-[3dvh]" style={{ paddingBottom: 'max(2dvh, env(safe-area-inset-bottom))', paddingTop: 'max(2dvh, env(safe-area-inset-top))' }}>
                        
                        <div className="w-full flex justify-center pop-in shrink-0 h-[6dvh] max-h-[60px]" style={{animationDelay: '0.1s'}}>
                            <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-full object-contain drop-shadow-sm" />
                        </div>
                        
                        <div className="flex flex-col items-center pop-in shrink-0 mt-[2dvh]" style={{animationDelay: '0.2s'}}>
                            <img src={ASSETS.dedoarriba} alt="Thumbs Up" className="h-[5dvh] max-h-[45px] mb-[1dvh] drop-shadow-md" />
                            <h2 className="text-[clamp(1.2rem,3dvh,1.8rem)] leading-[1.1] font-black text-[#0878A4] text-center">
                                Primero, registremos<br/>tus datos:
                            </h2>
                        </div>
                        
                        <form className="w-full max-w-sm flex-1 flex flex-col justify-center gap-[2dvh] pop-in shrink min-h-0 py-[1dvh]" style={{animationDelay: '0.3s'}} onSubmit={handleSubmit}>
                            <div className="shrink-0">
                                <label className="block text-[clamp(0.9rem,2dvh,1.2rem)] font-black text-[#0878A4] mb-[0.5dvh]">Nombre completo:</label>
                                <input 
                                    type="text" 
                                    required
                                    value={name} onChange={e => setName(e.target.value)}
                                    className={`w-full px-4 py-[1.2dvh] rounded-[1.5dvh] border-2 text-center text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#0878A4]/50 placeholder:text-slate-400 font-semibold transition-colors text-[clamp(0.9rem,2dvh,1.2rem)] ${highlightName ? 'animate-shake border-[#F9137C] bg-pink-50' : 'border-[#0878A4]'}`}
                                    placeholder="Ej: Juan P茅rez Calder贸n"
                                />
                            </div>

                            <div className="shrink-0">
                                <label className="block text-[clamp(0.9rem,2dvh,1.2rem)] font-black text-[#0878A4] mb-[0.5dvh]">DNI/CE:</label>
                                <input 
                                    type="text" 
                                    required maxLength={16}
                                    value={dni} onChange={e => setDni(e.target.value.replace(/[^0-9a-zA-Z]/g, ''))}
                                    className={`w-full px-4 py-[1.2dvh] rounded-[1.5dvh] border-2 text-center text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#0878A4]/50 placeholder:text-slate-400 font-semibold transition-colors text-[clamp(0.9rem,2dvh,1.2rem)] ${highlightDni ? 'animate-shake border-[#F9137C] bg-pink-50' : 'border-[#0878A4]'}`}
                                    placeholder="Ej: 07689324"
                                />
                            </div>
                            
                            <div className={`flex items-center justify-center gap-2 p-[0.5dvh] rounded-xl transition-colors shrink-0 ${highlightTerms ? 'animate-shake bg-pink-50' : ''}`}>
                                <button 
                                    type="button" 
                                    onClick={() => setTerms(!terms)}
                                    className={`w-[3dvh] h-[3dvh] max-w-[24px] max-h-[24px] rounded-full border-2 flex items-center justify-center transition-colors shrink-0 ${terms ? 'bg-[#0878A4] border-[#0878A4]' : (highlightTerms ? 'border-[#F9137C]' : 'border-[#0878A4] bg-transparent')}`}
                                >
                                    {terms && <div className="w-1/2 h-1/2 rounded-full bg-white"></div>}
                                </button>
                                <label className={`text-[clamp(0.6rem,1.5dvh,0.8rem)] font-semibold leading-tight text-left cursor-pointer transition-colors ${highlightTerms ? 'text-[#F9137C]' : 'text-[#0878A4]'}`} onClick={() => setTerms(!terms)}>
                                    Acepto los <span onClick={(e) => {e.stopPropagation(); setShowTermsModal(true);}} className="underline font-bold cursor-pointer hover:text-[#065b7c]">T茅rminos y Condiciones</span> de la campa帽a.
                                </label>
                            </div>
                            
                            <div className="flex items-center justify-center gap-[1.5dvh] mt-[1dvh] shrink-0">
                                <Button variant={isValid ? 'primary' : 'disabled'} onClick={handleSubmit} className="!w-auto px-[4dvh] !py-[1.2dvh] uppercase text-[clamp(1.5rem,3.5dvh,2.5rem)] leading-none tracking-wider rounded-[1.5dvh] font-black">
                                    LISTO
                                </Button>
                                
                                <div className={`text-[#F9137C] h-[4dvh] max-h-[35px] ${isValid ? 'animate-bounce-right' : 'opacity-50'}`}>
                                    <svg viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg" className="h-full w-auto">
                                        <path d="M0 0L24 20L0 40V0Z" />
                                    </svg>
                                </div>
                            </div>
                        </form>

                        <div className="w-full flex justify-center pop-in shrink-0 h-[3.5dvh] max-h-[35px]" style={{animationDelay: '0.4s'}}>
                            <img src={ASSETS.logoClasem} alt="Clasem EOM" className="h-full object-contain" />
                        </div>

                        {showTermsModal && (
                            <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center p-4 fade-enter">
                                <div className="bg-white rounded-[2dvh] p-[3dvh] w-full max-h-[80dvh] overflow-y-auto shadow-2xl">
                                    <h3 className="text-[clamp(1rem,2.5dvh,1.5rem)] font-bold mb-[2dvh]">T茅rminos y Condiciones</h3>
                                    <div className="text-[clamp(0.8rem,1.8dvh,1rem)] text-slate-600 space-y-[1dvh] mb-[3dvh] text-left">
                                        <p>1. Promoci贸n v谩lida para clientes registrados de CLASEM Inmobiliaria.</p>
                                        <p>2. Cada usuario tiene un m谩ximo de 5 intentos para alcanzar el puntaje necesario.</p>
                                        <p>3. Los premios no son acumulables. Solo se entregar谩 el premio correspondiente al nivel (Tier) m谩s alto alcanzado y guardado por el usuario.</p>
                                        <p>4. El c贸digo generado al final debe ser validado por un asesor de ventas para hacer efectivo el premio durante la separaci贸n de su departamento en "La Arboleda".</p>
                                    </div>
                                    <Button onClick={() => setShowTermsModal(false)} className="!py-[1.5dvh]">Cerrar</Button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const TutorialView = ({ onNext }) => (
            <div className="h-full w-full overflow-hidden bg-white fade-enter relative">
                <div className="flex flex-col items-center justify-between h-full w-full px-4 sm:px-6 py-[3dvh]" style={{ paddingBottom: 'max(2dvh, env(safe-area-inset-bottom))', paddingTop: 'max(2dvh, env(safe-area-inset-top))' }}>
                    
                    {/* Logo Arboleda Top */}
                    <div className="w-full flex justify-center pop-in shrink-0 h-[6dvh] max-h-[60px]" style={{animationDelay: '0.1s'}}>
                        <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-full object-contain drop-shadow-sm" />
                    </div>
                    
                    {/* Icono e Instrucci贸n */}
                    <div className="flex flex-col items-center pop-in shrink-0 mt-[1dvh]" style={{animationDelay: '0.2s'}}>
                        <img src={ASSETS.foco} alt="Foco" className="h-[5dvh] max-h-[45px] mb-[0.5dvh] drop-shadow-md" />
                        <h2 className="text-[clamp(1.5rem,3.5dvh,2.2rem)] leading-[1.1] font-black text-[#0878A4]">
                            驴C贸mo ganas?
                        </h2>
                    </div>
                    
                    {/* Animaci贸n del juego - Flexible */}
                    <div className="w-full max-w-[30dvh] aspect-square bg-[#f1f5f9] rounded-[2dvh] relative overflow-hidden shadow-inner shrink min-h-0 pop-in my-[1.5dvh]" style={{animationDelay: '0.3s'}}>
                        <MiniGamePreview />
                    </div>
                    
                    {/* Textos */}
                    <div className="w-full max-w-sm flex flex-col items-center gap-[0.5dvh] pop-in shrink-0" style={{animationDelay: '0.4s'}}>
                        <p className="text-[#F9137C] text-[clamp(0.7rem,1.8dvh,1rem)] font-medium leading-tight px-4 text-center">
                            Mueve el cami贸n de mudanza y<br/>atrapa todas las cajas que puedas<br/>en <strong className="font-black">30 segundos.</strong>
                        </p>
                        <p className="text-[#0878A4] text-[clamp(0.7rem,1.8dvh,1rem)] font-medium leading-tight mt-[0.5dvh] text-center">
                            隆Tienes <strong className="font-black">5 intentos</strong> para lograr tu mejor puntaje!
                        </p>
                    </div>

                    {/* Premios Horizontales */}
                    <div className="flex justify-center items-end gap-[2dvh] w-full shrink-0 pop-in my-[1.5dvh]" style={{animationDelay: '0.5s'}}>
                        {ASSETS.prizes.map((prize, idx) => {
                            const relativeHeights = ['h-[5dvh]', 'h-[8dvh]', 'h-[11dvh]'];
                            return (
                                <div key={prize.id} className="flex flex-col items-center">
                                    <img 
                                        src={prize.image} 
                                        className={`${relativeHeights[idx]} object-contain mb-[0.5dvh] drop-shadow-md`} 
                                        alt={prize.name} 
                                    />
                                    <div className="flex items-center gap-[0.5dvh]">
                                        <span className="text-[#F9137C] font-black text-[clamp(1rem,2.5dvh,1.5rem)] leading-none">{prize.minBoxes}</span>
                                        <img src={ASSETS.caja} alt="Caja" className="h-[2.5dvh] object-contain" />
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Bot贸n y Flecha */}
                    <div className="flex items-center justify-center gap-[1.5dvh] w-full max-w-sm shrink-0 pop-in" style={{animationDelay: '0.6s'}}>
                        <Button onClick={onNext} className="!w-auto px-[4dvh] uppercase text-[clamp(1.5rem,4dvh,2.5rem)] leading-none tracking-wider !py-[1.5dvh] rounded-[2dvh] font-black">
                            JUGAR
                        </Button>
                        
                        {/* Flecha Derecha */}
                        <div className="text-[#F9137C] animate-bounce-right shrink-0 h-[4dvh] max-h-[35px]">
                            <svg viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg" className="h-full w-auto">
                                <path d="M0 0L24 20L0 40V0Z" />
                            </svg>
                        </div>
                    </div>

                    {/* Logo Clasem Bottom */}
                    <div className="w-full flex justify-center pop-in shrink-0 mt-[1.5dvh] h-[3.5dvh] max-h-[35px]" style={{animationDelay: '0.7s'}}>
                        <img src={ASSETS.logoClasem} alt="Clasem EOM" className="h-full object-contain" />
                    </div>
                </div>
            </div>
        );

        const TransitionView = ({ attemptCount, onAnimationEnd }) => {
            useEffect(() => {
                const timer = setTimeout(onAnimationEnd, 2500);
                return () => clearTimeout(timer);
            }, [onAnimationEnd]);

            return (
                <div className="flex flex-col items-center justify-center h-full bg-[#F9137C] text-white fade-enter">
                    <div className="w-48 h-32 mb-4 bounce-in">
                        <TruckPreview />
                    </div>
                    <h2 className="text-[clamp(2rem,6dvh,4rem)] font-black text-white mb-2 uppercase text-center leading-[0.9] pop-in" style={{animationDelay: '0.1s'}}>
                        Intento<br/>{attemptCount} de {MAX_ATTEMPTS}
                    </h2>
                    <p className="text-pink-200 font-bold text-[clamp(1.2rem,3dvh,2rem)] animate-pulse mt-4 pop-in" style={{animationDelay: '0.3s'}}>
                        隆PREPRATE!
                    </p>
                </div>
            );
        };

        const getPrizeForScore = (score) => {
            for (let i = ASSETS.prizes.length - 1; i >= 0; i--) {
                if (score >= ASSETS.prizes[i].minBoxes) {
                    return ASSETS.prizes[i];
                }
            }
            return null;
        };

        const ResultView = ({ score, attemptCount, attemptsArr, onRetry, onClaim }) => {
            const previousAttempts = attemptsArr.slice(0, -1);
            const previousBestScore = previousAttempts.length > 0 ? Math.max(...previousAttempts) : 0;
            const previousBestPrize = getPrizeForScore(previousBestScore);
            
            const currentPrize = getPrizeForScore(score);
            const attemptsLeft = MAX_ATTEMPTS - attemptCount;

            const isMaintaining = previousBestPrize !== null && (!currentPrize || previousBestPrize.minBoxes >= currentPrize.minBoxes);
            const displayPrize = isMaintaining ? previousBestPrize : currentPrize;
            
            const getArticle = (name) => {
                const n = name.toLowerCase();
                return n.includes('lavadora') || n.includes('refrigeradora') ? 'UNA' : 'UN';
            };

            return (
                <div className="h-full w-full overflow-hidden bg-white fade-enter relative">
                    <div className="flex flex-col items-center justify-between h-full w-full px-4 sm:px-6 py-[3dvh]" style={{ paddingBottom: 'max(2dvh, env(safe-area-inset-bottom))', paddingTop: 'max(2dvh, env(safe-area-inset-top))' }}>
                        
                        {/* Logo Arboleda Top */}
                        <div className="w-full flex justify-center pop-in shrink-0 h-[6dvh] max-h-[60px]" style={{animationDelay: '0.1s'}}>
                            <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-full object-contain drop-shadow-sm" />
                        </div>

                        {/* Atrapaste Title */}
                        <div className="flex flex-col items-center justify-center pop-in shrink-0 mt-[1.5dvh]" style={{animationDelay:'0.2s'}}>
                            <h2 className="text-[clamp(1.5rem,3.5dvh,2rem)] font-black text-[#F9137C] leading-none mb-[0.5dvh]">
                                Atrapaste
                            </h2>
                            <div className="flex items-center justify-center gap-[1dvh]">
                                <img src={ASSETS.caja} alt="Caja" className="h-[4.5dvh] object-contain" />
                                <span className="text-[clamp(2.5rem,6dvh,4rem)] font-black text-[#F9137C] leading-none">{score < 10 ? `0${score}` : score}</span>
                            </div>
                        </div>
                        
                        {/* Prize Image & Background Wheel */}
                        <div className="relative w-full flex-1 flex justify-center items-center shrink min-h-0 my-[1dvh]">
                            <img src={ASSETS.rueda} className="absolute h-[130%] max-h-[45dvh] spin-slow z-0 pop-in opacity-20 object-contain" style={{animationDelay: '0.3s', filter: 'brightness(0) saturate(100%) invert(32%) sepia(85%) saturate(3015%) hue-rotate(318deg) brightness(101%) contrast(97%)'}} alt="Fondo Animado" />
                            {displayPrize ? (
                                <img src={displayPrize.image} className="relative h-full max-h-[25dvh] object-contain drop-shadow-2xl pop-in z-10 bounce-in" style={{animationDelay: '0.4s'}} alt="Premio" />
                            ) : (
                                <div className="relative z-10 text-[clamp(4rem,12dvh,7rem)] bounce-in leading-none" style={{animationDelay: '0.4s'}}></div>
                            )}
                        </div>

                        {/* Title Ganaste / Mantienes */}
                        <div className="pop-in shrink-0 mb-[2dvh]" style={{animationDelay:'0.5s'}}>
                            {displayPrize ? (
                                <h3 className="text-[clamp(1.3rem,3dvh,2.5rem)] font-black text-[#0878A4] leading-[1.1] uppercase px-2 text-center">
                                    {isMaintaining ? (
                                        <>隆MANTIENES TU<br/>{displayPrize.name}!</>
                                    ) : (
                                        <>隆GANASTE {getArticle(displayPrize.name)}<br/>{displayPrize.name}!</>
                                    )}
                                </h3>
                            ) : (
                                <h3 className="text-[clamp(1.3rem,3dvh,2.5rem)] font-black text-[#0878A4] leading-[1.1] uppercase px-2 text-center">
                                    隆SIGUE<br/>INTENTANDO!
                                </h3>
                            )}
                        </div>

                        {/* Botones */}
                        <div className="w-full flex flex-col gap-[1.5dvh] shrink-0 pop-in" style={{animationDelay:'0.6s'}}>
                            {attemptsLeft > 0 ? (
                                <>
                                    {/* Jugar (Izquierda) */}
                                    <div className="flex items-center justify-center gap-[1.5dvh] w-full max-w-[340px] mx-auto h-[7.5dvh] min-h-[50px]">
                                        <div className="text-[#0878A4] animate-bounce-left shrink-0 h-[4dvh] max-h-[30px]">
                                            <svg viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg" className="h-full w-auto">
                                                <path d="M24 0L0 20L24 40V0Z" />
                                            </svg>
                                        </div>
                                        <Button onClick={onRetry} className="!w-full h-full !bg-[#0878A4] hover:!bg-[#065b7c] flex-1 px-2 uppercase text-[clamp(1rem,2.5dvh,1.5rem)] leading-none tracking-wider rounded-[1.5dvh] font-black shadow-lg">
                                            JUGAR ({attemptsLeft} INTENTOS)
                                        </Button>
                                        <div className="w-[16px] sm:w-[20px] shrink-0"></div> {/* Spacer balance */}
                                    </div>
                                    
                                    {/* Reclamar (Derecha) */}
                                    {displayPrize && (
                                        <div className="flex items-center justify-center gap-[1.5dvh] w-full max-w-[340px] mx-auto h-[7.5dvh] min-h-[50px]">
                                            <div className="w-[16px] sm:w-[20px] shrink-0"></div> {/* Spacer balance */}
                                            <Button onClick={onClaim} className="!w-full h-full flex-1 px-2 uppercase text-[clamp(1rem,2.5dvh,1.5rem)] leading-none tracking-wider rounded-[1.5dvh] font-black shadow-lg">
                                                RECLAMAR MI PREMIO
                                            </Button>
                                            <div className="text-[#F9137C] animate-bounce-right shrink-0 h-[4dvh] max-h-[30px]">
                                                <svg viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg" className="h-full w-auto">
                                                    <path d="M0 0L24 20L0 40V0Z" />
                                                </svg>
                                            </div>
                                        </div>
                                    )}
                                </>
                            ) : (
                                <div className="flex items-center justify-center gap-[1.5dvh] w-full max-w-[340px] mx-auto h-[8dvh] min-h-[55px]">
                                    <Button onClick={onClaim} className="!w-full h-full px-8 uppercase text-[clamp(1.5rem,3.5dvh,2.5rem)] leading-none tracking-wider rounded-[2dvh] font-black">
                                        CONTINUAR
                                    </Button>
                                    <div className="text-[#F9137C] animate-bounce-right shrink-0 h-[4dvh] max-h-[35px]">
                                        <svg viewBox="0 0 24 40" fill="currentColor" xmlns="http://www.w3.org/2000/svg" className="h-full w-auto">
                                            <path d="M0 0L24 20L0 40V0Z" />
                                        </svg>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Logo Clasem Bottom */}
                        <div className="w-full flex justify-center pop-in shrink-0 mt-[2dvh] h-[3.5dvh] max-h-[35px]" style={{animationDelay: '0.7s'}}>
                            <img src={ASSETS.logoClasem} alt="Clasem EOM" className="h-full object-contain" />
                        </div>
                    </div>
                </div>
            );
        };

        const WinnerView = ({ userData, bestScore, uniqueCode }) => {
            const finalPrize = getPrizeForScore(bestScore);
            
            const getArticle = (name) => {
                const n = name.toLowerCase();
                return n.includes('lavadora') || n.includes('refrigeradora') ? 'UNA' : 'UN';
            };

            return (
                <div className="h-full w-full overflow-hidden bg-[#F9137C] fade-enter relative">
                    <div className="flex flex-col items-center justify-between h-full w-full px-4 sm:px-6 py-[3dvh]" style={{ paddingBottom: 'max(2dvh, env(safe-area-inset-bottom))', paddingTop: 'max(2dvh, env(safe-area-inset-top))' }}>
                        
                        {/* Logo Arboleda Top (Blanco) */}
                        <div className="w-full flex justify-center pop-in shrink-0 h-[6dvh] max-h-[60px]" style={{animationDelay: '0.1s'}}>
                            <img src={ASSETS.logoArboleda} alt="La Arboleda" className="h-full object-contain drop-shadow-sm" style={{ filter: 'brightness(0) invert(1)' }} />
                        </div>
                        
                        {finalPrize ? (
                            <>
                                {/* Textos Principales */}
                                <div className="pop-in shrink-0 text-center mt-[2dvh]" style={{animationDelay: '0.2s'}}>
                                    <h1 className="text-[clamp(2rem,4.5dvh,3rem)] font-black text-white leading-none uppercase tracking-tight">
                                        隆FELICIDADES!
                                    </h1>
                                    <h2 className="text-[clamp(1rem,2.2dvh,1.5rem)] font-bold text-white mt-[0.5dvh] uppercase leading-tight">
                                        Te llevas {getArticle(finalPrize.name)}<br/>{finalPrize.name}
                                    </h2>
                                </div>
                                
                                {/* Prize Image & Rueda Blanca */}
                                <div className="relative w-full flex-1 flex justify-center items-center min-h-0 shrink my-[1.5dvh]">
                                    <img src={ASSETS.rueda2} className="absolute h-[140%] max-h-[38dvh] spin-slow z-0 pop-in opacity-90 object-contain" style={{animationDelay: '0.3s'}} alt="Destello Blanco" />
                                    <img src={finalPrize.image} className="relative h-full max-h-[22dvh] object-contain drop-shadow-2xl pop-in z-10 bounce-in" style={{animationDelay: '0.4s'}} alt="Premio Ganado" />
                                </div>

                                {/* C谩mara e Instrucciones */}
                                <div className="flex flex-col items-center pop-in shrink-0 z-20" style={{animationDelay: '0.5s'}}>
                                    <img src={ASSETS.camara} alt="C谩mara" className="h-[4.5dvh] max-h-[40px] mb-[1dvh] drop-shadow-md" />
                                    <p className="text-white text-[clamp(0.7rem,1.8dvh,1rem)] font-bold leading-tight px-4 sm:px-6 max-w-xs text-center">
                                        T贸male una captura a esta pantalla y pres茅ntasela a tu asesor al separar tu depa.
                                    </p>
                                </div>
                                
                                {/* Bloque C贸digo de Ganador */}
                                <div className="w-full flex flex-col items-center pop-in shrink-0 z-20 mt-[1.5dvh]" style={{animationDelay: '0.6s'}}>
                                    <p className="text-white text-[clamp(0.9rem,2.2dvh,1.2rem)] font-medium mb-[0.5dvh]">
                                        C贸digo de ganador:
                                    </p>
                                    <div className="bg-white rounded-[2dvh] p-[2dvh] w-[95%] max-w-[320px] shadow-2xl flex flex-col items-center justify-center">
                                        <h2 className="text-[clamp(1.8rem,4.5dvh,2.5rem)] font-black text-[#1e293b] leading-none mb-[0.5dvh] tracking-widest">{uniqueCode}</h2>
                                        <p className="text-[#1e293b] font-semibold text-[clamp(0.75rem,1.8dvh,1rem)] leading-tight mt-[0.5dvh]">{userData.name}</p>
                                        <p className="text-[#1e293b] font-semibold text-[clamp(0.75rem,1.8dvh,1rem)] leading-tight">DNI/CE: {userData.dni}</p>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center shrink min-h-0">
                                <div className="text-[clamp(3rem,8dvh,5rem)] mb-[2dvh] opacity-80 pop-in leading-none"></div>
                                <h2 className="text-[clamp(1.5rem,4dvh,2.5rem)] font-extrabold mb-[1dvh] text-white pop-in" style={{animationDelay: '0.2s'}}>隆Gracias por jugar!</h2>
                                <p className="text-pink-100 px-4 pop-in text-[clamp(0.8rem,2dvh,1.1rem)]" style={{animationDelay: '0.3s'}}>Esta vez no lograste alcanzar el puntaje m铆nimo, pero tenemos grandes descuentos esper谩ndote en caseta de ventas.</p>
                            </div>
                        )}

                        {/* Logo Clasem Bottom (Blanco) */}
                        <div className="w-full flex justify-center pop-in shrink-0 mt-[2dvh] h-[3.5dvh] max-h-[35px]" style={{animationDelay: '0.7s'}}>
                            <img src={ASSETS.logoClasem} alt="Clasem EOM" className="h-full object-contain" style={{ filter: 'brightness(0) invert(1)' }} />
                        </div>
                    </div>
                </div>
            );
        };

        // --- CONTROLADOR PRINCIPAL (APP) ---
        const App = () => {
            // Estados de vista: SPLASH, REGISTER, TUTORIAL, TRANSITION, GAME, RESULT, WINNER
            const [view, setView] = useState('SPLASH');
            
            // Datos del jugador
            const [userData, setUserData] = useState({ name: '', dni: '' });
            const [attempts, setAttempts] = useState([]); // Array de puntajes
            const [uniqueCode, setUniqueCode] = useState('');

            // Inicializar DB en el montaje
            useEffect(() => {
                DBService.init();
            }, []);

            const currentAttemptCount = attempts.length + 1;
            const bestScore = attempts.length > 0 ? Math.max(...attempts) : 0;

            const generateCode = () => {
                return 'ARB-' + Math.random().toString(36).substring(2, 7).toUpperCase();
            };

            const finalizeGame = async () => {
                const code = generateCode();
                setUniqueCode(code);
                
                const finalPrize = getPrizeForScore(bestScore);
                
                // Guardar en DB (Mock o Real)
                await DBService.savePlayerResult({
                    playerName: userData.name,
                    playerDni: userData.dni,
                    bestScore: bestScore,
                    prizeWon: finalPrize ? finalPrize.name : 'Ninguno',
                    uniqueCode: finalPrize ? code : 'N/A',
                    attempts: attempts
                });

                setView('WINNER');
            };

            const handleGameOver = (score) => {
                const newAttempts = [...attempts, score];
                setAttempts(newAttempts);
                
                const achievedPrize = getPrizeForScore(score);
                
                // Si alcanz贸 el premio m谩ximo (Tier 3), terminamos autom谩ticamente
                if (achievedPrize && achievedPrize.id === 'tier3') {
                    // Esperar un segundito para que el estado se actualice bien antes de ir a Winner
                    setTimeout(() => {
                        const code = generateCode();
                        setUniqueCode(code);
                        DBService.savePlayerResult({
                            playerName: userData.name,
                            playerDni: userData.dni,
                            bestScore: Math.max(...newAttempts),
                            prizeWon: 'Refrigeradora',
                            uniqueCode: code,
                            attempts: newAttempts
                        }).then(() => setView('WINNER'));
                    }, 500);
                } else {
                    setView('RESULT');
                }
            };

            return (
                <div className="app-container">
                    {view === 'SPLASH' && (
                        <SplashView onNext={() => setView('REGISTER')} />
                    )}
                    
                    {view === 'REGISTER' && (
                        <RegisterView onNext={(data) => {
                            setUserData(data);
                            setView('TUTORIAL');
                        }} />
                    )}
                    
                    {view === 'TUTORIAL' && (
                        <TutorialView onNext={() => setView('TRANSITION')} />
                    )}

                    {view === 'TRANSITION' && (
                        <TransitionView 
                            attemptCount={currentAttemptCount} 
                            onAnimationEnd={() => setView('GAME')} 
                        />
                    )}

                    {view === 'GAME' && (
                        <div className="h-full w-full fade-enter">
                            <GameEngine onGameOver={handleGameOver} />
                        </div>
                    )}

                    {view === 'RESULT' && (
                        <ResultView 
                            score={attempts[attempts.length - 1]}
                            bestScore={bestScore}
                            attemptCount={attempts.length}
                            attemptsArr={attempts}
                            onRetry={() => setView('TRANSITION')}
                            onClaim={finalizeGame}
                        />
                    )}

                    {view === 'WINNER' && (
                        <WinnerView 
                            userData={userData}
                            bestScore={bestScore}
                            uniqueCode={uniqueCode}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
